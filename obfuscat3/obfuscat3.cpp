#include <stdio.h>
#include <string.h>

unsigned char cipher[] = 
{
    0xb4,0xcd,0x69,0x54,0xbd,0x67,0x20,0x9d,0xf2,0xc3,0x24,
    0x14,0xc2,0x1b,0xe9,0x6a,0x44,0x14,0x4e,0x39,0xc5,0xc8,0x5b,0x11,
    0x75,0xad,0xde,0xbb,0xfe,0xe4,0x6e,0x65,0x06,0x9a,0x91,0xfe,0xa0,
    0x68,0xa4,0x86,0x17,0x6c,0x0a,0xcf,0x1e,0x67,0xe3,0x0d,0x60,0x47,
    0x13,0x6b,0xd1,0x36,0xf2,0x77,0x58,0x76,0x1e,0x98,0xf5,0x7f,0x0a,
    0x92,0xb7,0x0a,0xea,0xae,0x46,0x7e,0x6a,0x18,0x4a,0x59,0x4e,0x71,
    0xb2,0xe1,0x41,0x7a,0x0b,0x31,0xba,0xc6,0xaa,0xcf,0xce,0x09,0xbf,
    0x2e,0xf8,0x4d,0x75,0xef,0x14,0xed,0x5f,0x66,0x44,0x6f,0xde,0xe2,
    0x7c,0x10,0x8c,0xb7,0x4e,0x6b,0xb2,0xd4,0xf6,0x91,0xd7,0x84,0x86,
    0x1f,0xf8,0x65,0x94,0x0b,0x14,0x28,0xfb,0xdd,0x47,0xf4,0xc1,0x17,
    0x42,0x3f,0x1e,0x38,0x07,0xbb,0x37,0x33,0x12,0x0c,0x16,0x68,0xe0,
    0x23,0x12,0x75,0x72,0xd9,0x71,0x7a,0x88,0xd0,0x46,0x28,0x88,0xad,
    0x1e,0x98,0x8f,0x92,0x7e,0x0e,0x69,0x29,0x37,0xb1,0xff,0xc5,0xaf,
    0x6f,0x41,0x37,0x65,0x0e,0xd2,0x62,0x11,0x8f,0xa6,0x3e,0x95,0xf5,
    0x80,0x9a,0xdc
};

unsigned char key[] = "Samsara";

unsigned char mysterious_box[256] = { 0 };

void exchange_encode(unsigned char* a, unsigned char* b)
{
	unsigned char tmp = *a;
	*a = *b;
	*b = tmp;
}

void init_encode( unsigned char key[]) {
	for (unsigned int i = 0; i < 256; i++)
		mysterious_box[i] = i;
	unsigned int keyLen = strlen((char*)key);
	unsigned char Ttable[256] = { 0 };
	for (int i = 0; i < 256; i++)
		Ttable[i] = key[i % keyLen];
    for (int j = 0, i = 0; i < 256; i++)
    {
        j = ((((j | mysterious_box[i]) + (j & mysterious_box[i])) ^ Ttable[i]) + ((((j | mysterious_box[i]) + (j & mysterious_box[i])) & Ttable[i]) << 1)) % 256;
        exchange_encode(&mysterious_box[i], &mysterious_box[j]);
    }
}
void obf_encode(unsigned char data[], unsigned int dataLen, unsigned char key[])
{
    unsigned char i = 0, j = 0;

    init_encode(key);

    for (unsigned h = 0; h < dataLen; h++) {
        i = ((i ^ 1) + ((i & 1) << 1)) % 256;
        j = ((j | mysterious_box[i]) + (j & mysterious_box[i])) % 256;
        exchange_encode(&mysterious_box[i], &mysterious_box[j]);
        unsigned char t = ((mysterious_box[i] | mysterious_box[j]) + (mysterious_box[i] & mysterious_box[j])) % 256;
        unsigned char k = mysterious_box[t];
        data[h] += k;
    }
}

int main()
{
    printf("I heard someone say that my question is too easy and can be solved entirely by AI.let's see how your algorithm recognition skills hold up.\n");
	printf("But I admit that confusing things is indeed fun.\n");
    unsigned char input[1000] ={0};
    

	unsigned int len = 0;
    printf("Input my flag: ");
    scanf("%s", input);
	len = strlen((char*)input);
	obf_encode(input, len, key);
	unsigned int cipherLen = sizeof(cipher) / sizeof(cipher[0]);
	if (len == cipherLen && memcmp(input, cipher, cipherLen) == 0) {
		printf("Congratulations! \n");
	} else {
		printf("Try again?\n");
	}
    return 0;
}
